// Prisma Schema для MSS Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Пользователи
model User {
  id        String  @id @default(uuid())
  email     String  @unique
  phone     String?
  firstName String
  lastName  String
  age       Int?
  avatarUrl String?
  role      Role    @default(USER)

  // Поля для аутентификации
  password             String? // Nullable для OAuth пользователей
  emailVerified        Boolean   @default(false)
  verificationToken    String?   @unique
  resetPasswordToken   String?   @unique
  resetPasswordExpires DateTime?

  // OAuth провайдеры
  vkId       String? @unique
  telegramId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings             Booking[]
  orders               Order[]
  subscriptions        Subscription[]
  subscriptionPayments SubscriptionPayment[]
  groupEnrollments     GroupEnrollment[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
  MASTER
}

// Мастера
model Master {
  id              String   @id @default(uuid())
  name            String
  bio             String?
  avatarUrl       String?
  vkLink          String?
  instagramLink   String?
  telegramLink    String?
  specializations String[]
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  events        Event[]
  regularGroups RegularGroup[]
  products      Product[]

  @@map("masters")
}

// События (мастер-классы, разовые события)
model Event {
  id                  String      @id @default(uuid())
  title               String
  description         String
  type                EventType
  status              EventStatus @default(DRAFT)
  startDate           DateTime
  endDate             DateTime
  maxParticipants     Int
  currentParticipants Int         @default(0)
  price               Float
  imageUrl            String?
  resultImages        String[]
  materials           String[]
  difficulty          Difficulty?
  masterId            String
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  master   Master    @relation(fields: [masterId], references: [id])
  bookings Booking[]

  @@map("events")
}

enum EventType {
  MASTER_CLASS
  REGULAR_GROUP
  ONE_TIME_EVENT
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// Постоянные группы (направления)
model RegularGroup {
  id               String   @id @default(uuid())
  name             String
  description      String
  shortDescription String
  imageUrl         String?
  schedule         Json // {daysOfWeek: [1,3,5], time: "18:00", duration: 90}
  price            Float
  maxParticipants  Int
  masterId         String
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  master      Master            @relation(fields: [masterId], references: [id])
  sessions    GroupSession[]
  enrollments GroupEnrollment[]

  @@map("regular_groups")
}

// Отдельные занятия направления
model GroupSession {
  id                  String        @id @default(uuid())
  groupId             String
  date                DateTime // Конкретная дата и время занятия
  duration            Int // Продолжительность в минутах
  status              SessionStatus @default(SCHEDULED)
  currentParticipants Int           @default(0)
  notes               String? // Причина отмены и т.д.
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  group    RegularGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@map("group_sessions")
}

enum SessionStatus {
  SCHEDULED // Запланировано
  CANCELLED // Отменено
  COMPLETED // Завершено
}

// Записи пользователей на постоянные направления (зачисление в группу)
model GroupEnrollment {
  id             String           @id @default(uuid())
  userId         String
  groupId        String
  subscriptionId String? // ID абонемента для оплаты занятий
  status         EnrollmentStatus @default(ACTIVE)
  enrolledAt     DateTime         @default(now())
  expiresAt      DateTime? // Срок окончания записи (опционально)
  notes          String?
  participants   Json // Данные участников
  contactEmail   String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  group        RegularGroup  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  bookings     Booking[] // Связанные записи на конкретные занятия

  @@map("group_enrollments")
}

enum EnrollmentStatus {
  ACTIVE // Активная запись
  PAUSED // Приостановлена
  CANCELLED // Отменена
  COMPLETED // Завершена
}

// Записи на события
model Booking {
  id                String        @id @default(uuid())
  userId            String?
  eventId           String? // Для мастер-классов
  groupSessionId    String? // Для занятий направлений
  groupEnrollmentId String? // Ссылка на зачисление в группу
  subscriptionId    String? // ID абонемента, если оплата через абонемент
  status            BookingStatus @default(PENDING)
  participantsCount Int           @default(1)
  totalPrice        Float
  paymentMethod     PaymentMethod @default(ON_SITE)
  notes             String?
  // Данные участников (массив объектов с fullName, phone, age)
  participants      Json
  // Контактный email для связи
  contactEmail      String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user            User?            @relation(fields: [userId], references: [id])
  event           Event?           @relation(fields: [eventId], references: [id])
  groupSession    GroupSession?    @relation(fields: [groupSessionId], references: [id])
  groupEnrollment GroupEnrollment? @relation(fields: [groupEnrollmentId], references: [id])
  subscription    Subscription?    @relation(fields: [subscriptionId], references: [id])

  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  ATTENDED
}

enum PaymentMethod {
  SUBSCRIPTION
  ON_SITE
  ONLINE
}

// Товары
model Product {
  id               String   @id @default(uuid())
  name             String
  description      String
  shortDescription String
  price            Float
  images           String[]
  category         String
  stockQuantity    Int
  isAvailable      Boolean  @default(true)
  masterId         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  master     Master?     @relation(fields: [masterId], references: [id])
  orderItems OrderItem[]

  @@map("products")
}

// Заказы
model Order {
  id            String        @id @default(uuid())
  userId        String
  totalAmount   Float
  status        OrderStatus   @default(PENDING)
  paymentMethod PaymentMethod @default(ON_SITE)
  paymentId     String?
  paymentUrl    String?
  paymentStatus String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user  User        @relation(fields: [userId], references: [id])
  items OrderItem[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  READY
  COMPLETED
  CANCELLED
}

// Позиции заказа
model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Float

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// Новости
model News {
  id          String    @id @default(uuid())
  title       String
  content     String
  imageUrl    String?
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("news")
}

// Загруженные файлы
model Upload {
  id           String   @id @default(uuid())
  originalName String
  filename     String
  mimetype     String
  size         Int
  path         String
  url          String
  createdAt    DateTime @default(now())

  @@map("uploads")
}

// Типы абонементов (шаблоны для пополнения)
model SubscriptionType {
  id           String   @id @default(uuid())
  name         String // Название (например, "Пополнить на 5000₽")
  description  String // Описание абонемента
  amount       Float // Сумма пополнения (баланс в рублях)
  price        Float // Стоимость (сколько нужно заплатить за пополнение)
  durationDays Int? // Срок действия в днях (null = бессрочный)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  subscriptions        Subscription[]
  subscriptionPayments SubscriptionPayment[]

  @@map("subscription_types")
}

// Абонементы пользователей
model Subscription {
  id               String             @id @default(uuid())
  userId           String
  typeId           String // Ссылка на тип абонемента
  name             String // Название абонемента (например, "Пополнение на 5000₽")
  totalBalance     Float // Общий баланс в рублях
  remainingBalance Float // Оставшийся баланс в рублях
  price            Float // Стоимость абонемента (сколько заплатили)
  status           SubscriptionStatus @default(ACTIVE)
  purchasedAt      DateTime           @default(now())
  expiresAt        DateTime? // Срок действия (опционально)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionType SubscriptionType      @relation(fields: [typeId], references: [id])
  bookings         Booking[]
  groupEnrollments GroupEnrollment[]
  payments         SubscriptionPayment[]

  @@map("subscriptions")
}

// Платежи за абонементы
model SubscriptionPayment {
  id             String    @id @default(uuid())
  userId         String
  typeId         String
  subscriptionId String?
  amount         Float
  price          Float
  status         String
  paymentId      String?
  paymentUrl     String?
  processedAt    DateTime?
  rolledBackAt   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionType SubscriptionType @relation(fields: [typeId], references: [id])
  subscription     Subscription?    @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@map("subscription_payments")
}

enum SubscriptionStatus {
  ACTIVE // Активный
  EXPIRED // Истёк срок действия
  DEPLETED // Баланс исчерпан
  CANCELLED // Отменён
}
